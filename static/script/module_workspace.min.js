void function(e,t,i){function n(){var n,o=arguments.callee,a=this,r=im.tk;return!a instanceof o?new o:(n=o.prototype,n.constructor=o,n.getImageURL=function(){var e=location.search;return e&&/\.jpg/.test(e)&&e.substring(1).split("image=")[1]},n.serializationHash=function(){var e={},t=location.hash.substring(1).split("&");return a.hash=location.hash,r.each(t,function(t,i){var n=i.split("=");try{e[n[0]]=encodeURI(n[1]).trim()}catch(o){}}),e},o.counter||(o.counter=[]),n.Init=function(){a.$img=a.removeInfo=a.information=a.origin=a.mask=a.rect=a.cache=a.index=a.placeholder=a.container=null,a.hash="",a.container=t.getElementById(im.config.container),a.info=t.getElementById("information"),a.done=t.getElementById("done"),a.cancel=t.getElementById("cancel"),a.addInfo=t.getElementById("addInfo"),a.pages=t.getElementById("pages"),a.postPhoto=t.getElementById("postPhoto"),a.ls=e.localStorage,im.data=a.serializationHash(),a.createImage(),a.createImagePreview(),a.createMask(a.container,0,0),t.addEventListener("mouseup",function(){r.isOnDom(a.placeholder)&&a.removePlaceholder()},!1),a.container.addEventListener("click",function(e){e=r.getEvent(e);for(var t=r.getTarget(e);t.nodeType!==1;)t=t.parentNode;/Area/.test(t.className)&&a.activeInfo(t,a.info)},!1),a.postPhoto.addEventListener("click",function(){},!1),a.done.addEventListener("click",function(e){e=r.getEvent(e);var i=t.querySelectorAll(".Area");a.checkDone(i,e)},!1),t.addEventListener("keypress",function(e){e=r.getEvent(e);var t=e.keyCode||e.charCode;46===t&&e.ctrlKey&&a.findParent(a.info)&&a.removeInfos(a.findParent(a.info))},!1),a.cancel.addEventListener("click",function(e){a.cancelEdit(e)},!1),a.addInfo.addEventListener("click",function(){a.queryInformation()},!1),e.addEventListener("hashchange",function(){return location.hash!=a.hash?(a.container.innerHTML="",im.data=a.serializationHash(),a.createMask(a.container,0,0),a.createImage(),a.createImagePreview(),!1):void 0},!1)},n.createImage=function(){a.image=r.getHtmlElement("img")},n.acceptMarkInfo=function(){var e=a.getAreaBundingRect(a.info),t=e.pop(),i=t.data;t.setAttribute("axis",e),a.addAreaInfo(t,i)},n.fixCSS=function(e,t){return"-moz-#:@;-ms-#:@;-o-#:@;-webkit-#:@;#:@;".replace(/#:@/g,e+":"+t)},n.createImagePreview=function(){var e=new Image,i=im.data.image,n=im.config,o=t.getElementById(im.config.information);i&&(a.offsetXY=[],a.$img=im.data.image,e.onload=function(){a.size=[this.width>n.maxWidth?n.maxWidth:this.width,this.height],a.container.appendChild(a.image),a.mask.style.width=a.size[0]+"px",a.mask.style.height=a.size[1]+"px",a.image.src=e.src,a.container.style.cssText="width:"+a.size[0]+"px;"+a.fixCSS("transition","all .6s ease-in"),o.innerHTML='<b>图片名称：</b><b style="color:red">'+decodeURIComponent(im.data.name||"Noname")+'</b> <b style="margin-left:10px">图片尺寸：</b>宽:'+e.width+"px 高:"+e.height+"px",a.addInfo.style.display="block",a.pages.innerHTML="<b>"+(im.data.page||1)+"</b>/"+(im.data.size||1),a.rect=r.getClinetRect(a.image),a.image.style.cssText="max-width:900px;opacity:1;"+a.fixCSS("transition","all .4s ease-in"),e.onload=e.onerror=null,a.loadMarkPoint(),a.loadInfomation()},e.onerror=function(){alert("图片读取错误，请确认图片是否存在！")},e.src=i)},n.loadInfomation=function(){a.queryInformation(1)},n.loadMarkPoint=function(){r.dynamicScriptProxy(im.config.url.query,{image:a.$img},function(e){e.data.forEach(function(e){var t=new Function("return ["+e.axis+"]")(),i=a.createArea(t[1],t[0],t[2]-2,t[3]-2,1);i.data||(i.data={}),i.setAttribute("submit",!0),i.setAttribute("axis",t.valueOf()),e.id&&i.setAttribute("_id",e.id),i.style.backgroundColor="rgba(0, 0, 0, 0.4)",e.title&&(i.data.title=e.title),e.desc&&e.desc!=="undefined"&&(i.data.desc=e.desc),e.link&&e.link!=="undefined"&&(i.data.link=e.link)})})},n.addInfomForm=function(e){im.module.dialog({width:464,height:150,title:"图片说明",maskDepth:40,cancelTxt:" ",drag:!0,html:'<textarea id="infoArea" placeholder="输入文字..." maxlength="90"></textarea><p style="color:red;" id="infoMassage">*限制90个字符</p><table width="100%"><tr><td>选择位置： <input type="radio" name="infoFix" checked="checked" id="infoTop"  />上 <input type="radio" name="infoFix" id="infoBottom" />下</td><td align="right"><input type="button" value=" 取消 " id="infoCancel" /> <input type="button" value=" 保存 " id="infoSave" /> <img src="images/data_waiting.gif" id="infoWait" /> </td></tr></table>'},function(){a.informationHandle.call(this,a,e),a.dragDialog(this)})},n.dragDialog=function(e){e.title.addEventListener("mousedown",function(){},!1)},n.informationHandle=function(e,i){for(var n=this,o=[["infoArea",function(){var e=/<(?:(?:\/?[A-Za-z]\w+\b(?:[=\s](['"]?)[\s\S]*?\1)*)|(?:!--[\s\S]*?--))>/;i&&i.dw&&(this[0].value=i.dw),this[0].addEventListener("keyup",function(t){t=r.getEvent(t);var i=r.getTarget(t);return e.test(i.value)?(i.style.cssText="border:solid 2px red;background:yellow;",o[1][0].innerHTML="只能录入文字！",o[5][0].style.display="none",!1):(i.removeAttribute("style"),o[5][0].style.display="",o[1][0].innerHTML="还可以输入"+(90-i.value.length)+"个文字",void 0)},!1)}],["infoMassage",function(){}],["infoTop",function(){}],["infoBottom",function(){i&&i.pos==="1"&&r.trigger(this[0],"click")}],["infoWait",function(){this[0].style.display="none"}],["infoSave",function(t){this[0].addEventListener("click",function(){var a=o[0][0].value;o[0][0].disabled=!0,o[2][0].disabled=!0,o[3][0].disabled=!0,o[4][0].style.display="",t.cancel.style.visibility="hidden",o[6][0].style.visibility="hidden",this.disabled=!0,""===a?e.deleteInformation(i&&i._id,n):(im.information.data=a,e.addInformation(i&&i._id,a,o[2][0].checked===!0?0:1,n))},!1)}],["infoCancel",function(e){this[0].addEventListener("click",function(){e.removeDailog()},!1)}]],a=o.length;a>0;)o[--a][0]=t.getElementById(o[a][0]),o[a][1](this)},n.createMask=function(e,t,i){a.mask=r.getHtmlElement("div"),e.appendChild(a.mask),a.mask.style.cssText="filter:alpha(opacity=5);opacity:0.05;background:#eee; position:absolute;width:"+t+"px;height:"+i+"px;",a.mask.addEventListener("mousedown",a.mousemoveCheckThreshold,!1)},n.queryInformation=function(e){var t=this;im.information||(im.information={}),r.dynamicScriptProxy(im.config.info.query,{image:t.$img},function(i){1===e?i.length>0&&t.createInfoPreview(i[0].dw,i[0].pos):t.addInfomForm(i)})},n.deleteInformation=function(e,t){r.dynamicScriptProxy(im.config.info.del,{image:a.$img,id:e},function(e){var i=im.information;a.informationContrl.call(t,e.state,1);try{delete i.data,delete i.preview.parentNode.removeChild(i.preview),delete i.preview}catch(n){}})},n.addInformation=function(e,t,n,o){var a=this,l={};l.image=a.$img,l.pos=n,l.decword=encodeURIComponent(t),e===i||(l.id=e),r.dynamicScriptProxy(im.config.info.add,l,function(e){a.informationContrl.call(o,e.state),a.createInfoPreview(t,n)})},n.createInfoPreview=function(e,t){var i=im.information;i.data,i.preview||(i.preview=r.getHtmlElement("div")),i.preview.innerHTML=e,i.preview.style.cssText="opacity:0;",i.preview.className="0"==t?"infoPreviewTop":"infoPreviewBottom",i.preview.style.cssText="opacity: 1;width:"+(a.size[0]-20)+"px;"+a.fixCSS("transition","all .4s ease-in .5s"),im.module.ws.container.appendChild(i.preview)},n.informationContrl=function(){var e=this;e.removeDailog()},n.mousemoveCheckThreshold=function(i){i=i||e.event,a.offsetXY.length||(a.offsetXY=r.getOffsetXY(a.image));var n=(r.getTarget(i),t.getElementsByTagName("body")[0]),o=r.getScrollPosition();({mousemove:function(e){e=r.getEvent(e),a.placeholder.parentNode&&(a.placeholder.style.left=a.origin[0]+"px",a.placeholder.style.top=a.origin[1]+"px",a.placeholder.style.width=e.clientX-a.origin[0]-2+o[0]+"px",a.placeholder.style.height=e.clientY-a.origin[1]-2+o[1]+"px")},mousedown:function(e){a.origin=[0,0],a.origin=[e.clientX+o[0],e.clientY+o[1]],a.placeholder=r.getHtmlElement("div"),a.placeholder.className="placeholder",r.isOnDom(a.placeholder)&&a.removePlaceholder(),n.appendChild(a.placeholder),a.placeholder.style.cssText="position:absolute;top:"+a.origin[0]+"px;left:"+a.origin[1]+"px;",a.mask.addEventListener("mouseup",a.mousemoveCheckThreshold,!1),a.mask.addEventListener("mousemove",a.mousemoveCheckThreshold,!1)},mouseup:function(e){var t=e.clientX-a.origin[0]+o[0],n=e.clientY-a.origin[1]+o[1],l=im.config.maxSize;r.isOnDom(a.placeholder)&&a.removePlaceholder(),l>t||l>n||(a.createArea(i.clientY+ +o[1]-a.offsetXY[1]-n,i.clientX+ +o[0]-a.offsetXY[0]-t,t,n),r.removeEventListener(a.mask,"mousemove",a.mousemoveCheckThreshold,!1),r.removeEventListener(a.mask,"mouseup",a.mousemoveCheckThreshold,!1))}})[i.type](i)},n.activeInfo=function(e,t){a.ls._markdata=JSON.stringify(e.data),e.appendChild(t),t.style.visibility="visible",t.style.display="block",e=t=null},n.resetBlur=function(){r.each(a.formItems,function(e,t){t.removeAttribute("style"),t.blur()})},n.removePlaceholder=function(){try{a.placeholder.parentNode.removeChild(a.placeholder)}catch(e){}},n.createArea=function(e,t,i,n,l){var d=new im.module.clip(a.container);return d.index=o.counter.length,o.counter.push(d),d.activity({top:e,left:t,width:i,height:n},function(){l||r.trigger(d.area,"click")}),d.area},n.removeInfoArea=function(e){e=r.getEvent(e);var t=r.getTarget(e),i=a.findParent(t);a.removeInfos(i)},n.proxyRemoveInfos=function(){a.removeInfos(a.findParent(a.info))},n.removeInfos=function(e){try{e.getAttribute("submit")?confirm("确定删除该标注区域吗？")&&a.deleteData(e,e.data):e.parentNode.removeChild(e)}catch(t){}},n.saveFormItemVale=function(e){var t=a.findParent(a.info);t.data||(t.data={}),t.data[e.name]=e.value},n.findParent=function(e){for(var t=e.parentNode;!/Area/gi.test(t.className);)t=t.parentNode;return t},n.loadInfo2Cache=function(e){e.data,t.getElementById("markForm").contentWindow},n.getAreaBundingRect=function(e){var t=a.findParent(e);return r.getClinetRect(e),[t.offsetLeft,t.offsetTop,t.offsetWidth,t.offsetHeight,t]},n.addAreaInfo=function(e,t){var n=/http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- .\/?%&=]*)?/,o={};n.test(t.link)&&(o.link=encodeURIComponent(t.link)),t.desc==i||(o.desc=encodeURIComponent(t.desc)),o.title=t.title||"imageMarker",e.getAttribute("_id")&&(o.id=e.getAttribute("_id")),o.axis=e.getAttribute("axis"),o.image=im.data.image,r.dynamicScriptProxy(im.config.url.add,o,function(t){t.state==="fail"&&(e.style.backgroundColor="rgba(255, 0, 0, 0.6)"),t.state==="succ"&&(e.style.border="solid 1px #fff",e.style.backgroundColor="rgba(0, 0, 0, 0.4)",e.setAttribute("submit",!0),e.setAttribute("_id",t._id)),a.info.style.visibility="hidden",a.info.style.display="none"})},n.checkDone=function(t,i){var n=0;if(t.length>0&&r.each(t,function(e,t){t.getAttribute("submit")||(t.style.backgroundColor="rgba(255, 0, 0, 0.4)",n++)}),n>0)return alert("还有 "+n+"个 标注区域没有保存！"),!1;if(0===n){if(!i)return!0;e.close()}return!1},n.cancelEdit=function(e){e=r.getEvent(e);var t=r.getTarget(e),i=a.findParent(t);"true"===i.getAttribute("submit")?a.info.style.visibility="hidden":a.removeInfos(i)},n.deleteData=function(e){r.dynamicScriptProxy(im.config.url.del,{image:a.$img,id:e.getAttribute("_id")},function(t){t.state==="succ"&&e.parentNode.removeChild(e)})},void 0)}im.module||(im.module={}),im.config||(im.config={}),im.config={container:"container",information:"info",maxWidth:900,maxSize:60,url:{add:"/im/pointlink/addpoint.ctrl?",del:"/im/pointlink/deletepoint.ctrl?",query:"/im/pointlink/querypoint.ctrl?"},info:{add:"/im/decword/addDecWord.ctrl",del:"/im/decword/deleteDecWord.ctrl",query:"/im/decword/queryDecWord.ctrl"}},im.module.ws||(im.module.ws=new n)}(window,document);